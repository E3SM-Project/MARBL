<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Adding a Namelist Parameter &#8212; MARBL 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Adding a Tracer" href="add-tracer.html" />
    <link rel="prev" title="Adding a Diagnostic" href="add-diagnostic.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="add-tracer.html" title="Adding a Tracer"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="add-diagnostic.html" title="Adding a Diagnostic"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MARBL 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >MARBL developer&#8217;s guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="development-examples.html" accesskey="U">Development Examples</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Adding a Namelist Parameter</a><ul>
<li><a class="reference internal" href="#marbl-code-changes">MARBL Code Changes</a><ul>
<li><a class="reference internal" href="#step-1-create-new-module-level-variable">Step 1. Create new module-level variable</a></li>
<li><a class="reference internal" href="#step-2-set-default-value">Step 2. Set default value</a></li>
<li><a class="reference internal" href="#step-3-add-the-parameter-to-marbl-parms-nml">Step 3. Add the parameter to <code class="docutils literal"><span class="pre">&amp;marbl_parms_nml</span></code></a></li>
<li><a class="reference internal" href="#step-4-add-the-parameter-to-marbl-registry">Step 4. Add the parameter to MARBL registry</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pop-code-changes">POP Code Changes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="add-diagnostic.html"
                        title="previous chapter">Adding a Diagnostic</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="add-tracer.html"
                        title="next chapter">Adding a Tracer</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/dev-guide/add-namelist-parm.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="adding-a-namelist-parameter">
<span id="add-namelist-parm"></span><h1>Adding a Namelist Parameter<a class="headerlink" href="#adding-a-namelist-parameter" title="Permalink to this headline">¶</a></h1>
<p>This is a 5 step process.
There are 4 changes to make in the Fortran code, all of which are made in <code class="docutils literal"><span class="pre">marbl_parms.F90</span></code> <a class="footnote-reference" href="#id2" id="id1">[*]</a> (which may be renamed <code class="docutils literal"><span class="pre">marbl_parms_mod.F90</span></code> in the near future).
There is also the added step of adding the new namelist to the model namelist generation tool.
Currently this is handled by the GCM (we will use POP as an example) but soon MARBL will be able to generate <code class="docutils literal"><span class="pre">marbl_in</span></code> for GCMs that use MARBL namelists directly to set parameters.
Other GCMs will be able to use a <code class="docutils literal"><span class="pre">put()</span></code> call to change the parameter.</p>
<div class="section" id="marbl-code-changes">
<h2>MARBL Code Changes<a class="headerlink" href="#marbl-code-changes" title="Permalink to this headline">¶</a></h2>
<p>For this example, we follow the minimum O2 needed for prodution and consumption parameter, which is <code class="docutils literal"><span class="pre">parm_o2_min</span></code> in the code.</p>
<div class="section" id="step-1-create-new-module-level-variable">
<h3>Step 1. Create new module-level variable<a class="headerlink" href="#step-1-create-new-module-level-variable" title="Permalink to this headline">¶</a></h3>
<p>All namelist parameters are module variables in <code class="docutils literal"><span class="pre">marbl_parms.F90</span></code>.
Further, all subroutines and module variables are public in this module.</p>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">r8</span><span class="p">),</span> <span class="k">target</span> <span class="kd">::</span> <span class="p">&amp;</span>
     <span class="n">parm_Fe_bioavail</span><span class="p">,</span>      <span class="p">&amp;</span> <span class="c">! fraction of Fe flux that is bioavailable</span>
     <span class="n">parm_o2_min</span><span class="p">,</span>           <span class="p">&amp;</span> <span class="c">! min O2 needed for prod &amp; consump. (nmol/cm^3)</span>
     <span class="n">parm_o2_min_delta</span><span class="p">,</span>     <span class="p">&amp;</span> <span class="c">! width of min O2 range (nmol/cm^3)</span>
     <span class="n">parm_kappa_nitrif</span><span class="p">,</span>     <span class="p">&amp;</span> <span class="c">! nitrification inverse time constant (1/sec)</span>
     <span class="p">.</span>
     <span class="p">.</span>
     <span class="p">.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">target</span></code> attribute is necessary because MARBL&#8217;s internal parameter registry makes use of pointers.</p>
</div>
</div>
<div class="section" id="step-2-set-default-value">
<h3>Step 2. Set default value<a class="headerlink" href="#step-2-set-default-value" title="Permalink to this headline">¶</a></h3>
<p>MARBL convention is to have a reasonable default value defined in case the variable is not included in <code class="docutils literal"><span class="pre">&amp;marbl_parms_nml</span></code>.</p>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">marbl_parms_set_defaults</span><span class="p">(</span><span class="n">km</span><span class="p">)</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
  <span class="c">!-----------------------------------------------------------------------</span>
  <span class="c">!  &amp;marbl_parms_nml</span>
  <span class="c">!-----------------------------------------------------------------------</span>

  <span class="n">parm_Fe_bioavail</span>         <span class="o">=</span> <span class="mf">1.0_r8</span>
  <span class="n">parm_o2_min</span>              <span class="o">=</span> <span class="mf">5.0_r8</span>
  <span class="n">parm_o2_min_delta</span>        <span class="o">=</span> <span class="mf">5.0_r8</span>
  <span class="n">parm_kappa_nitrif</span>        <span class="o">=</span> <span class="mf">0.06_r8</span> <span class="o">*</span> <span class="n">dps</span>  <span class="c">! (= 1/( days))</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3-add-the-parameter-to-marbl-parms-nml">
<h3>Step 3. Add the parameter to <code class="docutils literal"><span class="pre">&amp;marbl_parms_nml</span></code><a class="headerlink" href="#step-3-add-the-parameter-to-marbl-parms-nml" title="Permalink to this headline">¶</a></h3>
<p>To allow the variable to be read by the namelist, it needs to be defined in the namelist.</p>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">marbl_parms_read_namelist</span><span class="p">(</span><span class="n">nl_buffer</span><span class="p">,</span> <span class="n">marbl_status_log</span><span class="p">)</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
  <span class="k">NAMELIST</span> <span class="o">/</span><span class="n">marbl_parms_nml</span><span class="o">/</span> <span class="p">&amp;</span>
       <span class="n">parm_Fe_bioavail</span><span class="p">,</span> <span class="p">&amp;</span>
       <span class="n">parm_o2_min</span><span class="p">,</span> <span class="p">&amp;</span>
       <span class="n">parm_o2_min_delta</span><span class="p">,</span> <span class="p">&amp;</span>
       <span class="n">parm_kappa_nitrif</span><span class="p">,</span> <span class="p">&amp;</span>
       <span class="p">.</span>
       <span class="p">.</span>
       <span class="p">.</span>
</pre></div>
</div>
</div>
<div class="section" id="step-4-add-the-parameter-to-marbl-registry">
<h3>Step 4. Add the parameter to MARBL registry<a class="headerlink" href="#step-4-add-the-parameter-to-marbl-registry" title="Permalink to this headline">¶</a></h3>
<p>This registry allows the parameter to be both set by and returned to the GCM.</p>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">marbl_define_parameters</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">marbl_status_log</span><span class="p">)</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
  <span class="n">sname</span>     <span class="o">=</span> <span class="s1">&#39;parm_o2_min&#39;</span>
  <span class="n">lname</span>     <span class="o">=</span> <span class="s1">&#39;Minimum O2 needed for production and consumption&#39;</span>
  <span class="n">units</span>     <span class="o">=</span> <span class="s1">&#39;nmol/cm^3&#39;</span>
  <span class="n">datatype</span>  <span class="o">=</span> <span class="s1">&#39;real&#39;</span>
  <span class="n">group</span>     <span class="o">=</span> <span class="s1">&#39;marbl_parms_nml&#39;</span>
  <span class="n">rptr</span>      <span class="o">=&gt;</span> <span class="n">parm_o2_min</span>
  <span class="k">call </span><span class="n">this</span><span class="p">%</span><span class="n">add_var</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">lname</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span>                 <span class="p">&amp;</span>
                      <span class="n">marbl_status_log</span><span class="p">,</span> <span class="n">rptr</span><span class="o">=</span><span class="n">rptr</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">marbl_status_log</span><span class="p">%</span><span class="n">labort_marbl</span><span class="p">)</span> <span class="k">then</span>
<span class="k">    call </span><span class="n">log_add_var_error</span><span class="p">(</span><span class="n">marbl_status_log</span><span class="p">,</span> <span class="n">sname</span><span class="p">,</span> <span class="n">subname</span><span class="p">)</span>
    <span class="k">return</span>
<span class="k">  end if</span>
</pre></div>
</div>
<p>To set the value of this parameter, make the following call between the <code class="docutils literal"><span class="pre">init</span></code> and <code class="docutils literal"><span class="pre">complete_config_and_init</span></code> stages of setup:</p>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">call </span><span class="n">marbl_instance</span><span class="p">%</span><span class="n">parameters</span><span class="p">%</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;parm_o2_min&#39;</span><span class="p">,</span> <span class="mf">5.0_r8</span><span class="p">,</span> <span class="n">marbl_instance</span><span class="p">%</span><span class="n">StatusLog</span><span class="p">)</span>
</pre></div>
</div>
<p>To pass this value to the GCM, make the following call anytime after <code class="docutils literal"><span class="pre">complete_config_and_init</span></code>:</p>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">call </span><span class="n">marbl_instance</span><span class="p">%</span><span class="n">parameters</span><span class="p">%</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parm_o2_min&#39;</span><span class="p">,</span> <span class="n">local_parm_o2_min</span><span class="p">,</span> <span class="n">marbl_instance</span><span class="p">%</span><span class="n">StatusLog</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pop-code-changes">
<h2>POP Code Changes<a class="headerlink" href="#pop-code-changes" title="Permalink to this headline">¶</a></h2>
<p>To add a new variable to the MARBL namelist, see the <a class="reference external" href="http://www.cesm.ucar.edu/models/cesm1.2/pop2/doc/faq/#dev_newnamelist">POP FAQ</a>.
As mentioned previously, MARBL will soon have a tool for generating <code class="docutils literal"><span class="pre">marbl_in</span></code> itself, at which point this task will not require any changes to the GCM.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">MARBL expects to read the namelist from a string rather than a file.
The GCM needs to read the namelist from a file, store it in a string, and then ensure that every task has a copy of the string.
This is a different workflow than POP, where the master task reads the namelist directly from a file and then broadcasts each parameter to all the other tasks.
We use this method to avoid the need for multiple broadcasts &#8211; in POP, the master task stores the namelists in a single string and broadcasts that string to all other tasks.
From that point on, every task is setting its parameter values with a namelist read.</p>
</div>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[*]</a></td><td>The <code class="docutils literal"><span class="pre">&amp;marbl_config_nml</span></code> namelist is modified via similar steps in <code class="docutils literal"><span class="pre">marbl_config_mod.F90</span></code>.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="add-tracer.html" title="Adding a Tracer"
             >next</a> |</li>
        <li class="right" >
          <a href="add-diagnostic.html" title="Adding a Diagnostic"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MARBL 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >MARBL developer&#8217;s guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="development-examples.html" >Development Examples</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, National Science Foundation and U.S. Department of Energy.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>